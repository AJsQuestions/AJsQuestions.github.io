<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=preconnect href=https://api.fontshare.com crossorigin><link href="https://api.fontshare.com/v2/css?f[]=satoshi@400,500,600,700&f[]=clash-display@500,600,700&display=swap" rel=stylesheet><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap" rel=stylesheet><meta name=robots content="index, follow"><title>ML Trading Bot in 100 Lines of Code (Part 1) | AJ</title><meta name=keywords content><meta name=description content="Building a trading bot using a simple ML strategy"><meta name=author content="Jan 2024"><link rel=canonical href=https://ajsquestions.github.io/q1/><link crossorigin=anonymous href=/assets/css/stylesheet.ebcda73e346d72378d4eec3813d579b8e37f8d1bd80d364d76713646c662b1ff.css integrity="sha256-682nPjRtcjeNTuw4E9V5uON/jRvYDTZNdnE2RsZisf8=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://ajsquestions.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ajsquestions.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ajsquestions.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://ajsquestions.github.io/apple-touch-icon.png><meta name=theme-color content="#09090b"><meta name=msapplication-TileColor content="#09090b"><link rel=alternate hreflang=en href=https://ajsquestions.github.io/q1/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="ML Trading Bot in 100 Lines of Code (Part 1)"><meta property="og:description" content="Building a trading bot using a simple ML strategy"><meta property="og:type" content="article"><meta property="og:url" content="https://ajsquestions.github.io/q1/"><meta property="article:section" content="questions"><meta property="article:published_time" content="2024-01-04T00:00:00+00:00"><meta property="article:modified_time" content="2024-01-04T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="ML Trading Bot in 100 Lines of Code (Part 1)"><meta name=twitter:description content="Building a trading bot using a simple ML strategy"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Blog","item":"https://ajsquestions.github.io/questions/"},{"@type":"ListItem","position":2,"name":"ML Trading Bot in 100 Lines of Code (Part 1)","item":"https://ajsquestions.github.io/q1/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"ML Trading Bot in 100 Lines of Code (Part 1)","name":"ML Trading Bot in 100 Lines of Code (Part 1)","description":"Building a trading bot using a simple ML strategy","keywords":[],"articleBody":"Overview The world of financial trading is complex; it requires thorough knowledge of practical aspects of the trade cycle to successfully run a strategy.\nIn this project, I tried to make trading as simple as running a cell in a Jupyter notebook. The idea wasn’t to develop a sophisticated strategy, rather, to develop a strategy fast.\n1. The Data 1.1 Alpaca Alpaca is an API-first broker that allows you to trade and maintain your portfolio using their Python REST API. I used Alpaca as my broker and obtained API keys for my paper trading account.\n1.2 Universe I chose approximately 200 US ETFs from a larger universe of 4000+ listed US ETFs. The selection criterion was a threshold on the volume-weighted average price (VWAP) having a mean greater than 100 in the past month — a proxy measure for liquidity.\nThe list of 4000+ tickers was pulled from 12Data, which maintains an API endpoint for all 13000+ ETFs listed on major exchanges worldwide.\n1.3 OHLCV Data With our universe determined, I pull data for the last 8 years:\nimport numpy as np import pandas as pd from alpaca_trade_api.rest import REST, TimeFrame from ta import add_all_ta_features from datetime import datetime, timedelta from tqdm.auto import tqdm from sklearn.tree import DecisionTreeClassifier import warnings warnings.filterwarnings(\"ignore\") api = REST( key_id=\"YOUR-API-KEY\", secret_key=\"YOUR-SECRET-KEY\", base_url=\"https://paper-api.alpaca.markets\", api_version=\"v2\" ) us_etfs = pd.read_csv(\"YOUR-UNIVERSE.csv\") 2. Features and Split 2.1 Adding Features With OHLCV data pulled, we add all possible technical indicators from TA-Lib:\nprice[symbol] = df['close'] df = add_all_ta_features( df, open=\"open\", high=\"high\", low=\"low\", close=\"close\", volume=\"volume\" ).bfill().ffill() df['ret'] = np.log(df.close) - np.log(df.close.shift(1)) rets[symbol] = df['ret'] df['hi_lo_signal'] = np.where(df.ret \u003e 0, 1, 0) 2.2 Train/Test Split We split the data into train and test sets. Training period: all years through 2022. Test period: 2023 onwards.\ntrain = df[df.index.year \u003c= 2022] test = df[df.index.year \u003e 2022] X_train = train.drop(columns=['hi_lo_signal']).shift(1).dropna().reset_index(drop=True) y_train = train['hi_lo_signal'][2:] X_test = test.drop(columns=['hi_lo_signal']).shift(1).dropna().reset_index(drop=True) y_test = test['hi_lo_signal'][1:] 3. The Alpha Model The alpha model predicts which securities will rise in value the next day. I chose a Decision Tree Classifier after backtesting linear, regularized, non-parametric, and ensemble methods.\nclf = DecisionTreeClassifier(max_depth=10, random_state=42) clf = clf.fit(X_train, y_train) y_preds = clf.predict(X_test) if y_preds[-1] == 1: symbols_to_buy.append(symbol) else: symbols_to_sell.append(symbol) 4. Full Code import numpy as np import pandas as pd from alpaca_trade_api.rest import REST, TimeFrame from ta import add_all_ta_features from datetime import datetime, timedelta from tqdm.auto import tqdm from sklearn.tree import DecisionTreeClassifier import warnings warnings.filterwarnings(\"ignore\") api = REST( key_id=\"YOUR-API-KEY\", secret_key=\"YOUR-SECRET-KEY\", base_url=\"https://paper-api.alpaca.markets\", api_version='v2' ) us_etfs = pd.read_csv(\"YOUR-UNIVERSE.csv\") symbols_to_buy = [] symbols_to_sell = [] price = pd.DataFrame() rets = pd.DataFrame() current_time = datetime.now() yesterday = current_time - timedelta(days=1) end = yesterday.strftime('%Y-%m-%d') years = 3 start = current_time.replace(year=current_time.year - years).strftime('%Y-%m-%d') for symbol in tqdm(us_etfs['symbol']): bars = api.get_bars(symbol, TimeFrame.Day, start, end) if len(bars) == 0: continue df = bars.df price[symbol] = df['close'] df = add_all_ta_features( df, open=\"open\", high=\"high\", low=\"low\", close=\"close\", volume=\"volume\" ).bfill().ffill() df['ret'] = np.log(df.close) - np.log(df.close.shift(1)) rets[symbol] = df['ret'] df['hi_lo_signal'] = np.where(df.ret \u003e 0, 1, 0) train = df[df.index.year \u003c= 2022] test = df[df.index.year \u003e 2022] X_train = train.drop(columns=['hi_lo_signal']).shift(1).dropna().reset_index(drop=True) y_train = train['hi_lo_signal'][2:] X_test = test.drop(columns=['hi_lo_signal']).shift(1).dropna().reset_index(drop=True) y_test = test['hi_lo_signal'][1:] try: clf = DecisionTreeClassifier(max_depth=10, random_state=42) clf = clf.fit(X_train, y_train) y_preds = clf.predict(X_test) if y_preds[-1] == 1: symbols_to_buy.append(symbol) else: symbols_to_sell.append(symbol) except: continue Next Steps Our alpha model has created signals for which securities it expects to rise (long) or fall (short). How do we decide quantities to buy for each security? We discuss portfolio and risk management techniques in Part 2.\n","wordCount":"568","inLanguage":"en","datePublished":"2024-01-04T00:00:00Z","dateModified":"2024-01-04T00:00:00Z","author":{"@type":"Person","name":"Jan 2024"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://ajsquestions.github.io/q1/"},"publisher":{"@type":"Organization","name":"AJ","logo":{"@type":"ImageObject","url":"https://ajsquestions.github.io/favicon.ico"}}}</script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.css integrity=sha384-RZU/ijkSsFbcmivfdRBQDtwuwVqK7GMOw6IMvKyeWL2K5UAlyp6WonmB8m7Jd0Hn crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.js integrity=sha384-pK1WpvzWVBQiP0/GjnvRxV4mOb0oxFuyRxJlk6vVw146n3egcN5C925NCP7a7BY8 crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/contrib/auto-render.min.js integrity=sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl crossorigin=anonymous></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\begin{equation}",right:"\\end{equation}",display:!0},{left:"\\begin{equation*}",right:"\\end{equation*}",display:!0},{left:"\\begin{align}",right:"\\end{align}",display:!0},{left:"\\begin{align*}",right:"\\end{align*}",display:!0},{left:"\\begin{alignat}",right:"\\end{alignat}",display:!0},{left:"\\begin{gather}",right:"\\end{gather}",display:!0},{left:"\\begin{CD}",right:"\\end{CD}",display:!0}],throwOnError:!1})})</script></head><body class=dark id=top><header class=header><nav class=nav><div class=logo><a href=https://ajsquestions.github.io/ accesskey=h title=AJ><img src=https://ajsquestions.github.io/favicon-16x16.png alt aria-label=logo height=18 width=18>AJ</a><div class=logo-switches><ul class=lang-switch><li>|</li></ul></div></div><ul id=menu><li><a href=https://ajsquestions.github.io/about/ title=About><span>About</span></a></li><li><a href=https://ajsquestions.github.io/research/ title=Research><span>Research</span></a></li><li><a href=https://ajsquestions.github.io/blog/ title=Questions><span>Questions</span></a></li><li><a href=https://ajsquestions.github.io/contact/ title=Connect><span>Connect</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>ML Trading Bot in 100 Lines of Code (Part 1)</h1><div class=post-meta><div class=post-meta-items><span class=meta-date>January 2024</span><span class=meta-separator>·</span><span class=meta-author>Jan 2024</span></div></div></header><div class=toc><details open><summary accesskey=c><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#overview>Overview</a></li><li><a href=#1-the-data>1. The Data</a></li><li><a href=#2-features-and-split>2. Features and Split</a></li><li><a href=#3-the-alpha-model>3. The Alpha Model</a></li><li><a href=#4-full-code>4. Full Code</a></li><li><a href=#next-steps>Next Steps</a></li></ul></nav></div></details></div><div class=post-content><h2 id=overview>Overview<a hidden class=anchor aria-hidden=true href=#overview>#</a></h2><p>The world of financial trading is complex; it requires thorough knowledge of practical aspects of the trade cycle to successfully run a strategy.</p><p>In this project, I tried to make trading as simple as running a cell in a Jupyter notebook. The idea wasn&rsquo;t to develop a sophisticated strategy, rather, to develop <strong>a strategy fast</strong>.</p><hr><h2 id=1-the-data>1. The Data<a hidden class=anchor aria-hidden=true href=#1-the-data>#</a></h2><h3 id=11-alpaca>1.1 Alpaca<a hidden class=anchor aria-hidden=true href=#11-alpaca>#</a></h3><p>Alpaca is an API-first broker that allows you to trade and maintain your portfolio using their Python REST API. I used Alpaca as my broker and obtained API keys for my paper trading account.</p><h3 id=12-universe>1.2 Universe<a hidden class=anchor aria-hidden=true href=#12-universe>#</a></h3><p>I chose approximately <strong>200 US ETFs</strong> from a larger universe of 4000+ listed US ETFs. The selection criterion was a threshold on the volume-weighted average price (VWAP) having a mean greater than 100 in the past month — a proxy measure for liquidity.</p><p>The list of 4000+ tickers was pulled from 12Data, which maintains an API endpoint for all 13000+ ETFs listed on major exchanges worldwide.</p><h3 id=13-ohlcv-data>1.3 OHLCV Data<a hidden class=anchor aria-hidden=true href=#13-ohlcv-data>#</a></h3><p>With our universe determined, I pull data for the last 8 years:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> numpy <span style=color:#66d9ef>as</span> np
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> pandas <span style=color:#66d9ef>as</span> pd
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> alpaca_trade_api.rest <span style=color:#f92672>import</span> REST, TimeFrame
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> ta <span style=color:#f92672>import</span> add_all_ta_features
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> datetime <span style=color:#f92672>import</span> datetime, timedelta
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> tqdm.auto <span style=color:#f92672>import</span> tqdm
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> sklearn.tree <span style=color:#f92672>import</span> DecisionTreeClassifier
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> warnings
</span></span><span style=display:flex><span>warnings<span style=color:#f92672>.</span>filterwarnings(<span style=color:#e6db74>&#34;ignore&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>api <span style=color:#f92672>=</span> REST(
</span></span><span style=display:flex><span>    key_id<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;YOUR-API-KEY&#34;</span>, 
</span></span><span style=display:flex><span>    secret_key<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;YOUR-SECRET-KEY&#34;</span>, 
</span></span><span style=display:flex><span>    base_url<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;https://paper-api.alpaca.markets&#34;</span>, 
</span></span><span style=display:flex><span>    api_version<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;v2&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>us_etfs <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>read_csv(<span style=color:#e6db74>&#34;YOUR-UNIVERSE.csv&#34;</span>)
</span></span></code></pre></div><hr><h2 id=2-features-and-split>2. Features and Split<a hidden class=anchor aria-hidden=true href=#2-features-and-split>#</a></h2><h3 id=21-adding-features>2.1 Adding Features<a hidden class=anchor aria-hidden=true href=#21-adding-features>#</a></h3><p>With OHLCV data pulled, we add all possible technical indicators from TA-Lib:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>price[symbol] <span style=color:#f92672>=</span> df[<span style=color:#e6db74>&#39;close&#39;</span>]
</span></span><span style=display:flex><span>df <span style=color:#f92672>=</span> add_all_ta_features(
</span></span><span style=display:flex><span>    df, open<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;open&#34;</span>, high<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;high&#34;</span>, 
</span></span><span style=display:flex><span>    low<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;low&#34;</span>, close<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;close&#34;</span>, volume<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;volume&#34;</span>
</span></span><span style=display:flex><span>)<span style=color:#f92672>.</span>bfill()<span style=color:#f92672>.</span>ffill()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>df[<span style=color:#e6db74>&#39;ret&#39;</span>] <span style=color:#f92672>=</span> np<span style=color:#f92672>.</span>log(df<span style=color:#f92672>.</span>close) <span style=color:#f92672>-</span> np<span style=color:#f92672>.</span>log(df<span style=color:#f92672>.</span>close<span style=color:#f92672>.</span>shift(<span style=color:#ae81ff>1</span>))
</span></span><span style=display:flex><span>rets[symbol] <span style=color:#f92672>=</span> df[<span style=color:#e6db74>&#39;ret&#39;</span>]
</span></span><span style=display:flex><span>df[<span style=color:#e6db74>&#39;hi_lo_signal&#39;</span>] <span style=color:#f92672>=</span> np<span style=color:#f92672>.</span>where(df<span style=color:#f92672>.</span>ret <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>0</span>)
</span></span></code></pre></div><h3 id=22-traintest-split>2.2 Train/Test Split<a hidden class=anchor aria-hidden=true href=#22-traintest-split>#</a></h3><p>We split the data into train and test sets. Training period: all years through 2022. Test period: 2023 onwards.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>train <span style=color:#f92672>=</span> df[df<span style=color:#f92672>.</span>index<span style=color:#f92672>.</span>year <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>2022</span>]
</span></span><span style=display:flex><span>test <span style=color:#f92672>=</span> df[df<span style=color:#f92672>.</span>index<span style=color:#f92672>.</span>year <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>2022</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>X_train <span style=color:#f92672>=</span> train<span style=color:#f92672>.</span>drop(columns<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#39;hi_lo_signal&#39;</span>])<span style=color:#f92672>.</span>shift(<span style=color:#ae81ff>1</span>)<span style=color:#f92672>.</span>dropna()<span style=color:#f92672>.</span>reset_index(drop<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>y_train <span style=color:#f92672>=</span> train[<span style=color:#e6db74>&#39;hi_lo_signal&#39;</span>][<span style=color:#ae81ff>2</span>:]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>X_test <span style=color:#f92672>=</span> test<span style=color:#f92672>.</span>drop(columns<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#39;hi_lo_signal&#39;</span>])<span style=color:#f92672>.</span>shift(<span style=color:#ae81ff>1</span>)<span style=color:#f92672>.</span>dropna()<span style=color:#f92672>.</span>reset_index(drop<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>y_test <span style=color:#f92672>=</span> test[<span style=color:#e6db74>&#39;hi_lo_signal&#39;</span>][<span style=color:#ae81ff>1</span>:]
</span></span></code></pre></div><hr><h2 id=3-the-alpha-model>3. The Alpha Model<a hidden class=anchor aria-hidden=true href=#3-the-alpha-model>#</a></h2><p>The alpha model predicts which securities will rise in value the next day. I chose a <strong>Decision Tree Classifier</strong> after backtesting linear, regularized, non-parametric, and ensemble methods.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>clf <span style=color:#f92672>=</span> DecisionTreeClassifier(max_depth<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>, random_state<span style=color:#f92672>=</span><span style=color:#ae81ff>42</span>)
</span></span><span style=display:flex><span>clf <span style=color:#f92672>=</span> clf<span style=color:#f92672>.</span>fit(X_train, y_train)
</span></span><span style=display:flex><span>y_preds <span style=color:#f92672>=</span> clf<span style=color:#f92672>.</span>predict(X_test)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> y_preds[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>] <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>:
</span></span><span style=display:flex><span>    symbols_to_buy<span style=color:#f92672>.</span>append(symbol)
</span></span><span style=display:flex><span><span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>    symbols_to_sell<span style=color:#f92672>.</span>append(symbol)
</span></span></code></pre></div><hr><h2 id=4-full-code>4. Full Code<a hidden class=anchor aria-hidden=true href=#4-full-code>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> numpy <span style=color:#66d9ef>as</span> np
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> pandas <span style=color:#66d9ef>as</span> pd
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> alpaca_trade_api.rest <span style=color:#f92672>import</span> REST, TimeFrame
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> ta <span style=color:#f92672>import</span> add_all_ta_features
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> datetime <span style=color:#f92672>import</span> datetime, timedelta
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> tqdm.auto <span style=color:#f92672>import</span> tqdm
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> sklearn.tree <span style=color:#f92672>import</span> DecisionTreeClassifier
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> warnings
</span></span><span style=display:flex><span>warnings<span style=color:#f92672>.</span>filterwarnings(<span style=color:#e6db74>&#34;ignore&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>api <span style=color:#f92672>=</span> REST(
</span></span><span style=display:flex><span>    key_id<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;YOUR-API-KEY&#34;</span>, 
</span></span><span style=display:flex><span>    secret_key<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;YOUR-SECRET-KEY&#34;</span>, 
</span></span><span style=display:flex><span>    base_url<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;https://paper-api.alpaca.markets&#34;</span>, 
</span></span><span style=display:flex><span>    api_version<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;v2&#39;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>us_etfs <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>read_csv(<span style=color:#e6db74>&#34;YOUR-UNIVERSE.csv&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>symbols_to_buy <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>symbols_to_sell <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>price <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>DataFrame()
</span></span><span style=display:flex><span>rets <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>DataFrame()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>current_time <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>now()
</span></span><span style=display:flex><span>yesterday <span style=color:#f92672>=</span> current_time <span style=color:#f92672>-</span> timedelta(days<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>end <span style=color:#f92672>=</span> yesterday<span style=color:#f92672>.</span>strftime(<span style=color:#e6db74>&#39;%Y-%m-</span><span style=color:#e6db74>%d</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>years <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>start <span style=color:#f92672>=</span> current_time<span style=color:#f92672>.</span>replace(year<span style=color:#f92672>=</span>current_time<span style=color:#f92672>.</span>year <span style=color:#f92672>-</span> years)<span style=color:#f92672>.</span>strftime(<span style=color:#e6db74>&#39;%Y-%m-</span><span style=color:#e6db74>%d</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> symbol <span style=color:#f92672>in</span> tqdm(us_etfs[<span style=color:#e6db74>&#39;symbol&#39;</span>]):
</span></span><span style=display:flex><span>    bars <span style=color:#f92672>=</span> api<span style=color:#f92672>.</span>get_bars(symbol, TimeFrame<span style=color:#f92672>.</span>Day, start, end)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(bars) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>    df <span style=color:#f92672>=</span> bars<span style=color:#f92672>.</span>df
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    price[symbol] <span style=color:#f92672>=</span> df[<span style=color:#e6db74>&#39;close&#39;</span>]
</span></span><span style=display:flex><span>    df <span style=color:#f92672>=</span> add_all_ta_features(
</span></span><span style=display:flex><span>        df, open<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;open&#34;</span>, high<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;high&#34;</span>, 
</span></span><span style=display:flex><span>        low<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;low&#34;</span>, close<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;close&#34;</span>, volume<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;volume&#34;</span>
</span></span><span style=display:flex><span>    )<span style=color:#f92672>.</span>bfill()<span style=color:#f92672>.</span>ffill()
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    df[<span style=color:#e6db74>&#39;ret&#39;</span>] <span style=color:#f92672>=</span> np<span style=color:#f92672>.</span>log(df<span style=color:#f92672>.</span>close) <span style=color:#f92672>-</span> np<span style=color:#f92672>.</span>log(df<span style=color:#f92672>.</span>close<span style=color:#f92672>.</span>shift(<span style=color:#ae81ff>1</span>))
</span></span><span style=display:flex><span>    rets[symbol] <span style=color:#f92672>=</span> df[<span style=color:#e6db74>&#39;ret&#39;</span>]
</span></span><span style=display:flex><span>    df[<span style=color:#e6db74>&#39;hi_lo_signal&#39;</span>] <span style=color:#f92672>=</span> np<span style=color:#f92672>.</span>where(df<span style=color:#f92672>.</span>ret <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    train <span style=color:#f92672>=</span> df[df<span style=color:#f92672>.</span>index<span style=color:#f92672>.</span>year <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>2022</span>]
</span></span><span style=display:flex><span>    test <span style=color:#f92672>=</span> df[df<span style=color:#f92672>.</span>index<span style=color:#f92672>.</span>year <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>2022</span>]
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    X_train <span style=color:#f92672>=</span> train<span style=color:#f92672>.</span>drop(columns<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#39;hi_lo_signal&#39;</span>])<span style=color:#f92672>.</span>shift(<span style=color:#ae81ff>1</span>)<span style=color:#f92672>.</span>dropna()<span style=color:#f92672>.</span>reset_index(drop<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>    y_train <span style=color:#f92672>=</span> train[<span style=color:#e6db74>&#39;hi_lo_signal&#39;</span>][<span style=color:#ae81ff>2</span>:]
</span></span><span style=display:flex><span>    X_test <span style=color:#f92672>=</span> test<span style=color:#f92672>.</span>drop(columns<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#39;hi_lo_signal&#39;</span>])<span style=color:#f92672>.</span>shift(<span style=color:#ae81ff>1</span>)<span style=color:#f92672>.</span>dropna()<span style=color:#f92672>.</span>reset_index(drop<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>    y_test <span style=color:#f92672>=</span> test[<span style=color:#e6db74>&#39;hi_lo_signal&#39;</span>][<span style=color:#ae81ff>1</span>:]
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        clf <span style=color:#f92672>=</span> DecisionTreeClassifier(max_depth<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>, random_state<span style=color:#f92672>=</span><span style=color:#ae81ff>42</span>)
</span></span><span style=display:flex><span>        clf <span style=color:#f92672>=</span> clf<span style=color:#f92672>.</span>fit(X_train, y_train)
</span></span><span style=display:flex><span>        y_preds <span style=color:#f92672>=</span> clf<span style=color:#f92672>.</span>predict(X_test)
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> y_preds[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>] <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>:
</span></span><span style=display:flex><span>            symbols_to_buy<span style=color:#f92672>.</span>append(symbol)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            symbols_to_sell<span style=color:#f92672>.</span>append(symbol)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>continue</span>
</span></span></code></pre></div><hr><h2 id=next-steps>Next Steps<a hidden class=anchor aria-hidden=true href=#next-steps>#</a></h2><p>Our alpha model has created signals for which securities it expects to rise (long) or fall (short). How do we decide quantities to buy for each security? We discuss portfolio and risk management techniques in <strong>Part 2</strong>.</p></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>