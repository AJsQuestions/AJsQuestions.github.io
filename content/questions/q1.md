---
title: "ML Trading Bot in 100 Lines of Code (Part 1)" 
date: 2024-01-04
url: /q1
tags: ["Python", "Machine Learning", "Quant Finance"]
author: "Jan 2024"
summary: "Building a trading bot using a simple ML strategy" 
showToc: true
disableAnchoredHeadings: false
---

## Overview

The world of financial trading is complex; it requires thorough knowledge of practical aspects of the trade cycle to successfully run a strategy.

In this project, I tried to make trading as simple as running a cell in a Jupyter notebook. The idea wasn't to develop a sophisticated strategy, rather, to develop **a strategy fast**.

---

## 1. The Data

### 1.1 Alpaca

Alpaca is an API-first broker that allows you to trade and maintain your portfolio using their Python REST API. I used Alpaca as my broker and obtained API keys for my paper trading account.

### 1.2 Universe

I chose approximately **200 US ETFs** from a larger universe of 4000+ listed US ETFs. The selection criterion was a threshold on the volume-weighted average price (VWAP) having a mean greater than 100 in the past month â€” a proxy measure for liquidity.

The list of 4000+ tickers was pulled from 12Data, which maintains an API endpoint for all 13000+ ETFs listed on major exchanges worldwide.

### 1.3 OHLCV Data

With our universe determined, I pull data for the last 8 years:

```python
import numpy as np
import pandas as pd
from alpaca_trade_api.rest import REST, TimeFrame
from ta import add_all_ta_features
from datetime import datetime, timedelta
from tqdm.auto import tqdm
from sklearn.tree import DecisionTreeClassifier
import warnings
warnings.filterwarnings("ignore")

api = REST(
    key_id="YOUR-API-KEY", 
    secret_key="YOUR-SECRET-KEY", 
    base_url="https://paper-api.alpaca.markets", 
    api_version="v2"
)

us_etfs = pd.read_csv("YOUR-UNIVERSE.csv")
```

---

## 2. Features and Split

### 2.1 Adding Features

With OHLCV data pulled, we add all possible technical indicators from TA-Lib:

```python
price[symbol] = df['close']
df = add_all_ta_features(
    df, open="open", high="high", 
    low="low", close="close", volume="volume"
).bfill().ffill()

df['ret'] = np.log(df.close) - np.log(df.close.shift(1))
rets[symbol] = df['ret']
df['hi_lo_signal'] = np.where(df.ret > 0, 1, 0)
```

### 2.2 Train/Test Split

We split the data into train and test sets. Training period: all years through 2022. Test period: 2023 onwards.

```python
train = df[df.index.year <= 2022]
test = df[df.index.year > 2022]

X_train = train.drop(columns=['hi_lo_signal']).shift(1).dropna().reset_index(drop=True)
y_train = train['hi_lo_signal'][2:]

X_test = test.drop(columns=['hi_lo_signal']).shift(1).dropna().reset_index(drop=True)
y_test = test['hi_lo_signal'][1:]
```

---

## 3. The Alpha Model

The alpha model predicts which securities will rise in value the next day. I chose a **Decision Tree Classifier** after backtesting linear, regularized, non-parametric, and ensemble methods.

```python
clf = DecisionTreeClassifier(max_depth=10, random_state=42)
clf = clf.fit(X_train, y_train)
y_preds = clf.predict(X_test)

if y_preds[-1] == 1:
    symbols_to_buy.append(symbol)
else:
    symbols_to_sell.append(symbol)
```

---

## 4. Full Code

```python
import numpy as np
import pandas as pd
from alpaca_trade_api.rest import REST, TimeFrame
from ta import add_all_ta_features
from datetime import datetime, timedelta
from tqdm.auto import tqdm
from sklearn.tree import DecisionTreeClassifier
import warnings
warnings.filterwarnings("ignore")

api = REST(
    key_id="YOUR-API-KEY", 
    secret_key="YOUR-SECRET-KEY", 
    base_url="https://paper-api.alpaca.markets", 
    api_version='v2'
)

us_etfs = pd.read_csv("YOUR-UNIVERSE.csv")

symbols_to_buy = []
symbols_to_sell = []
price = pd.DataFrame()
rets = pd.DataFrame()

current_time = datetime.now()
yesterday = current_time - timedelta(days=1)
end = yesterday.strftime('%Y-%m-%d')
years = 3
start = current_time.replace(year=current_time.year - years).strftime('%Y-%m-%d')

for symbol in tqdm(us_etfs['symbol']):
    bars = api.get_bars(symbol, TimeFrame.Day, start, end)
    if len(bars) == 0:
        continue
    df = bars.df
    
    price[symbol] = df['close']
    df = add_all_ta_features(
        df, open="open", high="high", 
        low="low", close="close", volume="volume"
    ).bfill().ffill()
    
    df['ret'] = np.log(df.close) - np.log(df.close.shift(1))
    rets[symbol] = df['ret']
    df['hi_lo_signal'] = np.where(df.ret > 0, 1, 0)
    
    train = df[df.index.year <= 2022]
    test = df[df.index.year > 2022]
    
    X_train = train.drop(columns=['hi_lo_signal']).shift(1).dropna().reset_index(drop=True)
    y_train = train['hi_lo_signal'][2:]
    X_test = test.drop(columns=['hi_lo_signal']).shift(1).dropna().reset_index(drop=True)
    y_test = test['hi_lo_signal'][1:]
    
    try:
        clf = DecisionTreeClassifier(max_depth=10, random_state=42)
        clf = clf.fit(X_train, y_train)
        y_preds = clf.predict(X_test)
        
        if y_preds[-1] == 1:
            symbols_to_buy.append(symbol)
        else:
            symbols_to_sell.append(symbol)
    except:
        continue
```

---

## Next Steps

Our alpha model has created signals for which securities it expects to rise (long) or fall (short). How do we decide quantities to buy for each security? We discuss portfolio and risk management techniques in **Part 2**.
